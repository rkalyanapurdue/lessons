<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">

    <title>D3 Field Planting</title>

    <!-- load D3 -->
    <script src="https://rawcdn.githack.com/coopbri/hci-binder/362464110b5273593e9fdd1dc1c0ae3e4f1da224/lib/d3.min.js"></script>

    <!-- global styles -->
    <style>
      body          { font-family: helvetica, sans-serif;
                      -moz-user-select: none;
                      -webkit-user-select: none;
                      -ms-user-select: none;
                      user-select: none; }
      svg           { float:left;
                      margin-right: 80px; }
      #control      { width: 240px;
                      text-align: center;
                      margin-top: 10px;
                      position: absolute;
                      display: inline-block; }
      button        { margin: 0 5px 10px 5px;
                      padding: 3px; }
      #start        { margin-top: 20px; }
      #redfarmer    { pointer-events: none; }
      #bluefarmer   { pointer-events: none; }
      #purplefarmer { pointer-events: none; }
    </style>
  </head>

  <body>
    <script>
      // timer and parallel farmer timing intervals
      var timer = d3.timer(function() { timer.stop(); });
      var blueinterval;
      var purpleinterval;

      // parallel farmer stop booleans
      var bstop = false;
      var pstop = false;

      var body = d3.select("body");
      var svg = body.append("svg")
        .attr("width", 230)
        .attr("height", 300);
      var defs = svg.append("defs");
      var patterns = defs.append("pattern")
        .attr("id", "seedling")
        .attr("patternUnits", "userSpaceOnUse")
        .attr("width", 100).attr("height", 100)
      patterns.append("image")
        .attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/seedling.svg")
        .attr("x", 0).attr("y", 0)
        .attr("width", 100).attr("height", 100);

      var gradient = defs.append("linearGradient")
        .attr("id", "gradient")
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", "0%")
        .attr("y1", "0%")
        .attr("x2", "100%")
        .attr("y2", "0%");
      gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#3399cc")
        .attr("stop-opacity", 1);
      gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#cc33cc")
        .attr("stop-opacity", 1);

      // y-values of slider bars
      var yvalOne = 112;
      var yvalTwo = 182;

      // generate grid of nodes (field cells)
      function grid() {
        var grid = new Array();
        var xpos = 10;
        var ypos = 45;
        var width = 30;
        var height = 30;

        // draw farmland
        for (var row = 0; row < 6; row++) {
          for (var column = 0; column < 6; column++) {
            grid.push( new Array());
            grid[column].push({
              x: xpos,
              y: ypos,
              width: width,
              height: height,
            })
            xpos += width+5;
          }
          // reset x and y
          xpos = 10;
          ypos += height+5;
        }
        return grid;
      } // end grid generation function

      var farm = grid();

      var row = svg.selectAll(".row")
        .data(farm)
        .enter().append("g")
        .attr("id", function (d, i) { return "col" + i; });

      var column = row.selectAll(".square")
        .data(function (d) { return d; })
        .enter().append("image")
        .attr("xlink:href", function(d) {
           if (d.y < yvalOne) {
            return "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/empty-red.svg";
          } else if (d.y > yvalOne && d.y < yvalTwo) {
            return "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/empty-blue.svg";
          } else {
            return "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/empty-purple.svg";
          }
        })
        .attr("x", function (d) { return d.x; })
        .attr("y", function (d) { return d.y; })
        .attr("width", function (d) { return d.width; })
        .attr("height", function (d) { return d.height; })
        .attr("id", function (d, i) { return "cell" + i; })
        .classed("plot", true);

        // remove extra g tags generated by grid
        var extra = d3.selectAll("g").filter(function() {
          var col = this.id;
          var c = col.substr(3);
          return c > 5;
        });
        extra.remove();

      // draggable lines to portion field, y is constant
      svg.append("line")
        .attr("id", "sliderOne")
        .attr("x1", 10)
        .attr("y1", yvalOne)
        .attr("x2", 215)
        .attr("y2", yvalOne)
        .style("stroke", "#c1272d")
        .style("stroke-width", 10);
      svg.append("line")
        .attr("id", "sliderTwo")
        .attr("x1", 10)
        .attr("y1", yvalTwo)
        .attr("x2", 215)
        .attr("y2", yvalTwo)
        .style("stroke", "url(#gradient)")
        .style("stroke-width", 10);

      var drag = d3.drag()
        .on("drag", function() {
          d3.select(this)
            .attr("y1", d3.event.y)
            .attr("y2", d3.event.y);

            // move blue farmer position based on slider
            var yblue = d3.select("#sliderTwo").attr("y1");
            d3.select("#bluefarmer").attr("y", yblue - 77);
        })
        .on("end", function() {
          d3.select(this)
            .attr("y1", snap(d3.event.y))
            .attr("y2", snap(d3.event.y));

          var s1 = d3.select("#sliderOne").attr("y1");
          var s2 = d3.select("#sliderTwo").attr("y1");

          // check for slider overlaps
          if (+s1 >= +s2) {
            // keep top slider above bottom slider
            if (this.id === "sliderOne") {
              var move = snap(+d3.select("#sliderTwo").attr("y1") - 36);
              d3.select("#sliderOne").attr("y1", move);
              d3.select("#sliderOne").attr("y2", move);
            // keep bottom slider below top slider
            } else if (this.id === "sliderTwo") {
              var move = snap(+d3.select("#sliderOne").attr("y1") + 36);
              d3.select("#sliderTwo").attr("y1", move);
              d3.select("#sliderTwo").attr("y2", move);
            }
          }
          // update cell colors
          color();
        });

      // enable dragging on both slider bars
      drag(d3.selectAll("line"));

      // color-code cells based on farmer partition
      function color() {
        var s1 = d3.select("#sliderOne").attr("y1");
        var s2 = d3.select("#sliderTwo").attr("y1");

        // select cells above top slider bar
        var above = d3.selectAll("image.plot").filter(function() {
          var y = d3.select(this).attr("y");
            return (+y < +s1);
        });
        // select cells inbetween slider bars
        var middle = d3.selectAll("image.plot").filter(function() {
          var y = d3.select(this).attr("y");
          return (+y >= +s1 && +y < +s2);
        });
        // select cells below bottom slider bar
        var below = d3.selectAll("image.plot").filter(function() {
          var y = d3.select(this).attr("y");
          return (+y >= +s2);
        });

        // move blue farmer position based on slider
        var yblue = d3.select("#sliderTwo").attr("y1");
        d3.select("#bluefarmer").attr("y", yblue - 77);

        // color cells according to portions
        above.attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/empty-red.svg");
        middle.attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/empty-blue.svg");
        below.attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/empty-purple.svg");
      }

      // snap dragged position
      function snap(y) {
        // beyond bounds of plot
        if (y <  64) { return 38;  }
        if (y > 237) { return 257; }

        // within bounds of plot, top to bottom
        if (y > 64 && y < 92) {
          return 78;
        } else if (y > 92 && y < 130) {
          return yvalOne;
        } else if (y > 130 && y < 166) {
          return 148;
        } else if (y > 166 && y < 200) {
          return yvalTwo;
        } else if (y > 200 && y < 237) {
          return 218;
        }
      }

      // draw red farmer
      svg.append("image").attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/farmer.svg")
        .attr("id", "redfarmer")
        .attr("width", 40)
        .attr("y", 0);

      // draw blue farmer
      svg.append("image").attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/bluefarmer.svg")
        .attr("id", "bluefarmer")
        .attr("width", 40)
        .attr("y", 105);

      // draw purple farmer
      svg.append("image").attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/purplefarmer.svg")
        .attr("id", "purplefarmer")
        .attr("width", 40)
        .attr("y", 175);

      body.append("br");

      var control = body.append("div").attr("id", "control");

      var rstats = control.append("div")
        .style("border", "solid 3px #c1272d")
        .style("color", "#c1272d");

      rstats.append("p").text("Sam")
        .style("text-decoration", "underline")
        .style("font-weight", 600);

      // red farmer speed control buttons
      rstats.append("p").attr("id", "redspeed").text("Speed: fast");
      var redspeed = 100;
      rstats.append("button").text("Slow")
        .on("click", function() {
          redspeed = 750;
          d3.select("#redspeed").text("Speed: slow");
        });
      rstats.append("button").text("Medium")
        .on("click", function() {
          redspeed = 500;
          d3.select("#redspeed").text("Speed: medium");
        });
      rstats.append("button").text("Fast")
        .on("click", function() {
          redspeed = 100;
          d3.select("#redspeed").text("Speed: fast");
        });

      control.append("br");

      var pstats = control.append("div")
        .style("border", "solid 3px")
        .style("color", "#cc33cc")
        .style("border-image-source", "linear-gradient(90deg, #cc33cc, #3399cc)")
        .style("border-image-slice", 1);

      pstats.append("p").text("Parker and Patricia")
        .style("text-decoration", "underline")
        .style("text-decoration-color", "#3399cc")
        .style("font-weight", 600)
        .style("background", "-webkit-linear-gradient(45deg, #cc33cc, #3399cc)")
        .style("-webkit-background-clip", "text")
        .style("-webkit-text-fill-color", "transparent");

      // blue and purple farmer speed control buttons
      pstats.append("p").attr("id", "purplespeed").text("Speed: fast")
        .style("background", "-webkit-linear-gradient(45deg, #cc33cc, #3399cc)")
        .style("-webkit-background-clip", "text")
        .style("-webkit-text-fill-color", "transparent");
      var purplespeed = 100;
      pstats.append("button").text("Slow")
        .on("click", function() {
          purplespeed = 750;
          d3.select("#purplespeed").text("Speed: slow");
        });
      pstats.append("button").text("Medium")
        .on("click", function() {
          purplespeed = 500;
          d3.select("#purplespeed").text("Speed: medium");
        });
      pstats.append("button").text("Fast")
        .on("click", function() {
          purplespeed = 100;
          d3.select("#purplespeed").text("Speed: fast");
        });

      // total duration timer
      control.append("p").attr("id", "counter")
        .text("Duration: " + 0 + " seconds")
        .style("font-size", "20px");

      // start automatic planting
      var dist = 36;
      var i = 0;
      var j = 0;
      control.append("button").text("Start").attr("id", "start").on("click", function() {
        // start timer
        var rstop = false;
        timer.restart(function(dur) {
          d3.select("#counter").text(function() {
            var time = Math.floor(dur / 1000);
            if (time === 1) { return "Duration: " + time + " second" }
            else { return "Duration: " + time + " seconds" }
          });
          if (rstop && bstop && pstop) {
            timer.stop();
          }
        });

        d3.select(this).attr("disabled", true);
        d3.select("#reset").attr("disabled", null);

        // disable dragging
        d3.selectAll("line").on(".drag", null);

        var redfarmer = d3.select("#redfarmer");
        redinterval = setInterval(function() {
          if (+redfarmer.attr("y") < +d3.select("#sliderOne").attr("y1")-50) {
            var col = d3.select("#col" + i);
            col.select("#cell" + j).attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/seedling-red.svg");

            // check if row is even or odd
            if (j % 2 === 0) {
              i++;
              if (i !== 6) {
                redfarmer.attr("x", function() {
                  return +d3.select(this).attr("x") + dist;
                });
              }
            } else {
              i--;
              if (i !== -1) {
                redfarmer.attr("x", function() {
                  return +d3.select(this).attr("x") - dist;
                });
              }
            }

            // jump to next row upon reaching right end
            if (i === 6) {
                i = 5;
                j++;
                redfarmer.attr("y", function() {
                  return +d3.select(this).attr("y") + dist;
                });
            }

            // jump to next row upon reaching left end
            if (i === -1) {
              i = 0;
              j++;
              redfarmer.attr("y", function() {
                return +d3.select(this).attr("y") + dist;
              });
            }
          } else {
            rstop = true;
            clearInterval(redinterval);

            // start parallel farmers
            parallel();
          }
        }, redspeed);
      });

      // start parallel farmer motion
      function parallel() {
        m = 0;
        var bluefarmer = d3.select("#bluefarmer");
        var bluestart = +bluefarmer.attr("y");
        var nstart = 0;
        n = 0;
        if (bluestart === 35) {
          n = 1;
          nstart = 1;
        } else if (bluestart === 71) {
          n = 2;
        } else if (bluestart === 105) {
          n = 3;
          nstart = 1;
        } else if (bluestart === 141) {
          n = 4;
        } else if (bluestart === 180) {
          n = 5;
          nstart = 1;
        }
        blueinterval = setInterval(function() {
          if (+bluefarmer.attr("y") > +d3.select("#sliderOne").attr("y1")-50
           && +bluefarmer.attr("y") < +d3.select("#sliderTwo").attr("y1")-50) {
            var col = d3.select("#col" + m);
            col.select("#cell" + n).attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/seedling-blue.svg");

            // starting on odd row
            if (nstart === 1) {
              // check if row is even or odd
              if (n % 2 === 0) {
                m--;
                if (m !== 6 && m !== -1) {
                  bluefarmer.attr("x", function() {
                    return +d3.select(this).attr("x") - dist;
                  });
                }
              } else {
                m++;
                if (m !== -1 && m !== 6) {
                  bluefarmer.attr("x", function() {
                    return +d3.select(this).attr("x") + dist;
                  });
                }
              }

              // jump to next row upon reaching left end
              if (m === -1) {
                m = 0;
                n--;
                bluefarmer.attr("y", function() {
                  return +d3.select(this).attr("y") - dist;
                });
              }

              // jump to next row upon reaching right end
              if (m === 6) {
                  m = 5;
                  n--;
                  bluefarmer.attr("y", function() {
                    return +d3.select(this).attr("y") - dist;
                  });
              }
            // starting on even row
            } else {
              // check if row is even or odd
              if (n % 2 === 0) {
                m++;
                if (m !== 6 && m !== -1) {
                  bluefarmer.attr("x", function() {
                    return +d3.select(this).attr("x") + dist;
                  });
                }
              } else {
                m--;
                if (m !== -1 && m !== 6) {
                  bluefarmer.attr("x", function() {
                    return +d3.select(this).attr("x") - dist;
                  });
                }
              }

              // jump to next row upon reaching left end
              if (m === -1) {
                m = 0;
                n--;
                bluefarmer.attr("y", function() {
                  return +d3.select(this).attr("y") - dist;
                });
              }

              // jump to next row upon reaching right end
              if (m === 6) {
                  m = 5;
                  n--;
                  bluefarmer.attr("y", function() {
                    return +d3.select(this).attr("y") - dist;
                  });
              }
            }
          } else {
            bstop = true;
            clearInterval(blueinterval);
          }
        }, purplespeed);

        k = 0;
        l = 5;
        var purplefarmer = d3.select("#purplefarmer");
        purpleinterval = setInterval(function() {
          if (+purplefarmer.attr("y") > +d3.select("#sliderTwo").attr("y1")-50) {
            var col = d3.select("#col" + k);
            col.select("#cell" + l).attr("xlink:href", "https://rawcdn.githack.com/coopbri/hci-binder/0a0f8e02e3a3e7429f881b69634200d671c0f560/notebooks/parallel-computation/supplementary/seedling-purple.svg");

            // check if row is even or odd
            if (l % 2 === 0) {
              k--;
              if (k !== 6 && k !== -1) {
                purplefarmer.attr("x", function() {
                  return +d3.select(this).attr("x") - dist;
                });
              }
            } else {
              k++;
              if (k !== -1 && k !== 6) {
                purplefarmer.attr("x", function() {
                  return +d3.select(this).attr("x") + dist;
                });
              }
            }

            // jump to next row upon reaching left end
            if (k === -1) {
              k = 0;
              l--;
              purplefarmer.attr("y", function() {
                return +d3.select(this).attr("y") - dist;
              });
            }

            // jump to next row upon reaching right end
            if (k === 6) {
                k = 5;
                l--;
                purplefarmer.attr("y", function() {
                  return +d3.select(this).attr("y") - dist;
                });
            }
          } else {
            pstop = true;
            clearInterval(purpleinterval);
          }
        }, purplespeed);
      }

      // reset simulation
      control.append("button").text("Reset").attr("id", "reset")
        .attr("disabled", true)
        .on("click", function() {
          // stop timer and reset duration
          timer.stop();
          d3.select("#counter").text("Duration: " + 0 + " seconds");

          // clear farmer runtime code
          clearInterval(redinterval);
          clearInterval(blueinterval);
          clearInterval(purpleinterval);

          // enable start button
          d3.select("#start").attr("disabled", null);

          // enable dragging
          d3.selectAll("line").call(drag);

          // reset tile counters
          i = 0;
          j = 0;
          m = 0;
          n = 0;
          k = 0;
          l = 0;

          // update cell colors
          color();

          d3.select("#redfarmer").attr("x", 0).attr("y", 0);
          d3.select("#bluefarmer").attr("x", 0).attr("y", function() {
            var yblue = d3.select("#sliderTwo").attr("y1");
            return yblue - 77;
          });
          d3.select("#purplefarmer").attr("x", 0).attr("y", 175);
          d3.select(this).attr("disabled", true);
      });
    </script>
  </body>
</html>
